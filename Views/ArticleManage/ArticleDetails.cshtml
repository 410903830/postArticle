﻿@model postArticle.viewmodel.ArticleDetailsViewModel
@using PagedList.Mvc;
<link href="~/Content/PagedList.css" rel="stylesheet" type="text/css" />

@{
    var article = Model.article;
    ViewBag.Title = Model.article.Title;
    var messages = Model.messages;
    int UserID = 0;
    ViewData["reporttxt"] = "";
    

    if (Session["UserID"] != null)
    {
        UserID = (int)Session["UserID"];
    }
}

<style>
    /* 弹出层的内容样式 */
    .popup-overlay form {
        position: absolute;
        left: 50%;
        top: 50%;
        transform: translate(-50%, -50%);
    }

    /* 覆盖整个网页 */
    .popup-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.5); /* 半透明背景色，可以根据需要调整透明度 */
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 9999; /* 确保弹出层在其他元素之上 */
    }

    body {
        background-color: #A4DA8A;
        font-family: Arial, sans-serif;
    }

    .article-container {
        max-width: 800px;
        padding: 20px;
        background-color: #fff;
        border-radius: 5px;
    }

    .article-title {
        font-size: 30px;
        font-weight: bold;
        margin-bottom: 10px;
    }

    .article-author {
        font-size: 16px;
        color: #888;
        margin-bottom: 10px;
    }

    .article-content {
        font-size: 18px;
        margin-bottom: 20px;
    }

    .article-image img {
        max-width: 100%;
        height: auto;
        margin-bottom: 20px;
    }

    .article-time {
        margin-left: auto;
        font-size: 14px;
        color: #888;
        margin-bottom: 10px;
    }

    .comments-container {
        border-top: 1px solid #ccc;
        padding-top: 20px;
        background-color: #d7ffd1
    }

    .comment-item {
        margin-bottom: 20px;
        padding-bottom: 20px;
        border-bottom: 1px solid #ccc;
    }

    .comment-header {
        margin-bottom: 10px;
        font-weight: bold;
    }

    .comment-content {
        font-size: 16px;
        margin-bottom: 10px;
    }

    .comment-info {
        font-size: 14px;
        color: #888;
    }

    .add-comment-button {
        text-align: right;
        margin-top: 20px;
    }

        .add-comment-button button {
            padding: 10px 20px;
            background-color: #37a844;
            border: none;
            border-radius: 5px;
            color: #fff;
            cursor: pointer;
            font-size: 16px;
        }

            .add-comment-button button:hover,
            .add-comment-button button:focus {
                background-color: #2f863a;
            }

/*report css */

    .report_view {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.5); /* 半透明背景色，可以根据需要调整透明度 */
        display: none;
        align-items: center;
        justify-content: center;
        z-index: 3;
    }
    .report_alert {
        position: absolute;
        left: 50%;
        top: 50%;
        background-color: azure;
        width: 40%;
        height: 30%;
        z-index: 4;
        transform: translate(-50%,-50%);/*畫面至中*/
        border-radius: 4px;
    }
        .report_alert button .report_cancel {
            position: absolute;
            bottom: 0;
        }


</style>


<hr />

<div class="row">
    <div class="col-xl-7 article-container">
        <h2 class="article-title">@Html.DisplayFor(model => article.Title)</h2>
        <p class="article-author">Author: @Html.DisplayFor(model => article.UserManage.UserName)</p>
        <div class="article-content">
            @Html.DisplayFor(model => article.Content)
        </div>
        <div class="article-image">
            <img src="~/Uploads/@Html.DisplayFor(model => article.ImageURL)" alt="Article Image">
        </div>
        <p class="article-time">@Html.DisplayFor(model => article.Time)</p>
        @{ 
            if (Model.isCreatedByUser)
            {
            <button class="btn bi-star-fill" onclick="ArticleManage('@Url.Action("ArticleEdit")','@Model.article.ArticleID','編輯')">
                編輯文章|
            </button>
            <button class="btn bi-star-fill" onclick="ArticleManage('@Url.Action("ArticleDelete")','@Model.article.ArticleID','刪除')">
                刪除文章|
            </button>
            }
            else if (Model.isUser)
            {
            <button class="btn bi-star-fill report">檢舉文章</button>
                }
            }
    </div>

    <div class="col-xl-5 comments-container">
        <h4>留言</h4>
        @foreach (var item in messages)
        {
            <div class="comment-item">
                <div class="comment-header">
                    @if (Model.isUser && UserID != item.UserID)
                    {
                        @Html.ActionLink(item.UserManage.UserName, "DemoChar", "CharRoom", new { id = item.UserID }, null)
                    }
                    else
                    {
                        @Html.DisplayFor(modelItem => item.UserManage.UserName)
                    }
                </div>
                <div class="comment-content">
                    @Html.DisplayFor(modelItem => item.Content)
                </div>
                <div class="comment-info">
                    @Html.DisplayFor(modelItem => item.Time)
                </div>
            </div>
        }
    </div>
</div>



<!--檢舉視窗-->
<div class="report_view">
<div class="report_alert">


    <form>
        @Html.Label("不實文章")
        <input type="checkbox" name="report" value="不實文章">
        <br>
        @Html.Label("不當發言")
        <input type="checkbox" name="report" value="不當發言">
        <br>
        @Html.Label("謾罵字眼")
        <input type="checkbox" name="report" value="謾罵字眼">
        <br>
        @Html.Label("其他")
        <br>
        @Html.TextArea("report_other", new { placeholder = "請輸入想要檢舉內容(限制字數50字)", maxlength="50" ,@style="width:50%; high:50%; resize:none;" })

        <button class="report_cancel btn btn-danger">取消</button>
        <button class="report_submit btn btn-success">送出</button>

    </form>
</div>
</div>

<div id="Div_Browser">test</div>



<!-- 顯示留言的部分檢視區塊 -->
@*@Html.Partial("MessageSection", Model)*@



@if (Model.isUser)
{
    <div class="add-comment-button">
        <button onclick="openPopup()">新增留言</button>
    </div>
}


Page @(Model.messages.PageCount < Model.messages.PageNumber ? 0 : Model.messages.PageNumber) of
@Model.messages.PageCount


@Html.PagedListPager(Model.messages, page => Url.Action("ArticleDetails",
    new { id = Model.article.ArticleID, page }))



<div id="messagePopup" style="display:@Model.Display" class="popup-overlay">
    @using (Html.BeginForm("", "", FormMethod.Post, new { id = "SendMessage" }))
    {
        @Html.AntiForgeryToken()
        @Html.ValidationSummary(true, "", new { @class = "text-danger" })

        @Html.LabelFor(model => model.Content, htmlAttributes: new { @class = "control-label col-md-2", style = "color:#fff" })
        @Html.EditorFor(model => model.Content, new { htmlAttributes = new { @class = "form-control" } })
        @Html.ValidationMessageFor(model => model.Content, "", new { @class = "text-danger" })
        @Html.HiddenFor(model => model.Display)

        <button class="btn btn-success" type="submit">確定</button>
        <button class="btn btn-danger" type="button" onclick="closePopup()">取消</button>
    }
</div>

<div>
    <button class="btn btn-warning" type="button" onclick="location.href='@Url.Action("ArticleIndex", "Home")'">返回首頁</button>
</div>


<script>

    

    function openPopup() {
        document.getElementById("messagePopup").style.display = "block";
    }

    function closePopup() {
        document.getElementById("messagePopup").style.display = "none";
    }

    $(document).ready(function() {
            $('#SendMessage').submit(function(event) {
                event.preventDefault(); // 阻止表單的默認提交行為
                var redirectUrl = '@Url.Action("CreateMessage", "MessageManage")' +'?id='+ encodeURIComponent('@Model.article.ArticleID')+ '&page=' + encodeURIComponent('@Model.Page');
                var formData = $(this).serialize();
               // 使用 AJAX 發送 POST 請求
                makeAjaxRequest(redirectUrl, formData);
            });
     });

    function ArticleManage(url, id, action) {
        var redirectUrl = url + '?id=' + encodeURIComponent(id);
        if (action == "刪除") {
            var result = confirm("是否" + action + "此文章？");

            if (result) {
                makeAjaxRequest(redirectUrl, null);
            }
        }
        else {
            window.location.href = redirectUrl;
        }
    }



    //點擊檢舉按鈕
    $(".report").click(function () {
        $(".report_view").fadeIn("fast")
        $("body").css("overflow", "hidden")
    })
    //點擊檢舉取消按鈕
    $(".report_cancel").click(function () {
        $(".report_view").fadeOut("fast")
        $("body").css("overflow", "visible")

    })
    //點擊送出按鈕
    $(".report_submit").click(function () {


        $.post("/ArticleManage/ReportArticle",
            { Name: report() , ID:@UserID},
            function (data) { $("#Div_Browser").html(data); }
        );

    });


    //將檢舉內容整理成字串
     function report() {
        var reportname = document.forms[0];
        var reportadd = document.getElementById("report_other");
        var txt = "";
        for (var i = 0; i < reportname.length; i++) {
            if (reportname[i].checked) {
                txt = txt + reportname[i].value +",";
            }
        }
         txt = txt + reportadd.value;
         return txt;
    };



</script>